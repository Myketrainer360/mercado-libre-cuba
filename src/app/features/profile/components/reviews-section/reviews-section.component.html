<section class="reviews-section">
  <!-- Header con rating complessivo -->
  <div class="reviews-header">
    <div class="header-content">
      <h2 class="section-title">‚≠ê Rese√±as</h2>

      <!-- Rating complessivo -->
      <div class="overall-rating" *ngIf="totalReviews > 0">
        <div class="rating-display">
          <span class="rating-value">{{ averageRating.toFixed(1) }}</span>
          <div class="rating-stars">
            <span
              class="star"
              *ngFor="let star of getStarsArray(averageRating)"
              [class.filled]="star.filled"
              [class.half]="star.half"
            >
              {{ star.filled ? "‚≠ê" : star.half ? "‚≠ê" : "‚òÜ" }}
            </span>
          </div>
          <span class="rating-count"
            >{{ totalReviews }} rese√±a{{ totalReviews !== 1 ? "s" : "" }}</span
          >
        </div>
      </div>
    </div>

    <!-- Pulsante per lasciare recensione (solo se non √® il proprio profilo) -->
    <div class="header-actions" *ngIf="!isOwnProfile && canWriteReview">
      <button class="write-review-button" (click)="openReviewForm()">
        <span class="button-icon">‚úçÔ∏è</span>
        <span class="button-text">Escribir Rese√±a</span>
      </button>
    </div>
  </div>

  <!-- Distribuzione rating -->
  <div
    class="rating-distribution"
    *ngIf="totalReviews > 0 && getRatingDistribution()"
  >
    <h3 class="subsection-title">Distribuci√≥n de Calificaciones</h3>

    <div class="distribution-bars">
      <div
        class="distribution-item"
        *ngFor="let item of getRatingDistribution()"
      >
        <span class="stars-label">{{ item.stars }} ‚≠ê</span>
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="item.percentage"
            [attr.aria-valuenow]="item.percentage"
            [attr.aria-label]="
              item.stars + ' estrellas: ' + item.count + ' rese√±as'
            "
          ></div>
        </div>
        <span class="count-label">{{ item.count }}</span>
      </div>
    </div>
  </div>

  <!-- Filtri -->
  <div class="reviews-filters" *ngIf="reviews.length > 0">
    <div class="filter-group">
      <label class="filter-label">Ordenar por:</label>
      <select
        title="Sort reviews"
        class="filter-select"
        [(ngModel)]="sortBy"
        (change)="onSortChange()"
      >
        <option value="recent">M√°s recientes</option>
        <option value="oldest">M√°s antiguos</option>
        <option value="highest">Mejor valoradas</option>
        <option value="lowest">Peor valoradas</option>
      </select>
    </div>

    <div class="filter-group">
      <label class="filter-label">Filtrar por:</label>
      <select
        title="Filter reviews by rating"
        class="filter-select"
        [(ngModel)]="filterRating"
        (change)="onFilterChange()"
      >
        <option value="all">Todas</option>
        <option value="5">5 estrellas</option>
        <option value="4">4 estrellas</option>
        <option value="3">3 estrellas</option>
        <option value="2">2 estrellas</option>
        <option value="1">1 estrella</option>
      </select>
    </div>
  </div>

  <!-- Loading state -->
  <div class="loading-reviews" *ngIf="isLoading">
    <div class="skeleton-review" *ngFor="let item of [1, 2, 3]">
      <div class="skeleton-avatar"></div>
      <div class="skeleton-content">
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
      </div>
    </div>
  </div>

  <!-- Lista recensioni -->
  <div
    class="reviews-list"
    *ngIf="!isLoading && getFilteredReviews().length > 0"
  >
    <article
      class="review-card"
      *ngFor="let review of getFilteredReviews()"
      [attr.aria-label]="'Rese√±a de ' + review.reviewerName"
    >
      <!-- Header recensione -->
      <div class="review-header">
        <img
          alt="Avatar-reviewer"
          [src]="review.reviewerAvatar || '/assets/images/default-avatar.png'"
          [alt]="review.reviewerName"
          class="reviewer-avatar"
        />

        <div class="reviewer-info">
          <h4 class="reviewer-name">{{ review.reviewerName }}</h4>
          <div class="review-meta">
            <div class="review-stars">
              <span
                class="star small"
                *ngFor="let star of getStarsArray(review.rating)"
                [class.filled]="star.filled"
              >
                {{ star.filled ? "‚≠ê" : "‚òÜ" }}
              </span>
            </div>
            <span class="review-date">{{ formatDate(review.date) }}</span>
          </div>
        </div>
      </div>

      <!-- Contenuto recensione -->
      <div class="review-content">
        <p class="review-comment">{{ review.comment }}</p>

        <!-- Info annuncio correlato -->
        <div class="related-ad" *ngIf="review.adTitle">
          <span class="ad-icon">üì¢</span>
          <span class="ad-title">Sobre: {{ review.adTitle }}</span>
        </div>
      </div>

      <!-- Azioni recensione (solo per proprio profilo) -->
      <div class="review-actions" *ngIf="isOwnProfile">
        <button
          class="action-button"
          (click)="respondToReview(review)"
          [attr.aria-label]="'Responder a rese√±a de ' + review.reviewerName"
        >
          üí¨ Responder
        </button>
        <button
          class="action-button"
          (click)="reportReview(review)"
          [attr.aria-label]="'Reportar rese√±a'"
        >
          ‚ö†Ô∏è Reportar
        </button>
      </div>
    </article>
  </div>

  <!-- Empty state -->
  <div class="empty-reviews" *ngIf="!isLoading && reviews.length === 0">
    <div class="empty-icon">‚≠ê</div>
    <h3 class="empty-title">No hay rese√±as todav√≠a</h3>
    <p class="empty-description">
      {{
        isOwnProfile
          ? "Cuando completes transacciones, los usuarios podr√°n dejarte rese√±as aqu√≠."
          : "S√© el primero en dejar una rese√±a para este usuario."
      }}
    </p>
  </div>

  <!-- Paginazione -->
  <div
    class="reviews-pagination"
    *ngIf="getFilteredReviews().length > itemsPerPage"
  >
    <button
      class="pagination-button"
      [disabled]="currentPage === 1"
      (click)="previousPage()"
    >
      ‚Üê Anterior
    </button>

    <span class="pagination-info">
      P√°gina {{ currentPage }} de {{ getTotalPages() }}
    </span>

    <button
      class="pagination-button"
      [disabled]="currentPage === getTotalPages()"
      (click)="nextPage()"
    >
      Siguiente ‚Üí
    </button>
  </div>
</section>
